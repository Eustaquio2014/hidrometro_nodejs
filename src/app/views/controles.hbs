<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="Content-Language" content="pt-br">
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/favicon.ico">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Hidro Monitor</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/css/light-bootstrap-dashboard.css?v=2.0.0 " rel="stylesheet" />


  <!--CHARTJS CSS-->
  <link rel="stylesheet" type="text/css" href="/plugins/charts/chartjs/css/style_chartjs.css">

  <link rel="stylesheet" type="text/css" href="/assets/css/select.css">


  <!--CHARTJSREALTIME-->
  <style>
    .gauge {
      display: inline-block;
      margin: 0 auto;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }

    .size-1 {
      width: 12%;
    }

    .size-2 {
      width: 20%;
    }

    .size-3 {
      width: 48%;
    }

    .size-100 {
      width: 100%;
      height: 270px;
    }

    .justify-content-center {
      justify-content: center !important
    }

    .chart_boxx {
      width: 350px;
      margin: 0 auto;
    }
  </style>

  <!--APEX CHART-->
  <style>
    #chart,
    .chart-box {
      padding-top: 20px;
      padding-left: 10px;
      margin-left: 10px;
      margin-right: 10px;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 22px 35px -16px rgba(0, 0, 0, 0.1);
    }

    select.flat-select {
      -moz-appearance: none;
      -webkit-appearance: none;
      appearance: none;
      background: #ec0000 url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'60px\' height=\'60px\'><polyline fill=\'white\' points=\'46.139,15.518 25.166,36.49 4.193,15.519\'/></svg>") no-repeat scroll right 2px top 9px / 16px 16px;
      border: 0 none;
      border-radius: 3px;
      color: #fff;
      font-family: arial, tahoma;
      font-size: 16px;
      font-weight: bold;
      outline: 0 none;
      height: 33px;
      padding: 5px 20px 5px 10px;
      text-align: center;
      text-indent: 0.01px;
      text-overflow: "";
      text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
      transition: all 0.3s ease 0s;
      width: auto;
      -webkit-transition: 0.3s ease all;
      -moz-transition: 0.3s ease all;
      -ms-transition: 0.3s ease all;
      -o-transition: 0.3s ease all;
      transition: 0.3s ease all;
    }

    select.flat-select:focus,
    select.flat-select:hover {
      border: 0;
      outline: 0;
    }


    .apexcharts-canvas {
      margin: 0 auto;
    }
  </style>

</head>

<body class="">
  <div class="wrapper">
    <div class="sidebar" data-image="../assets/img/4.png" data-color="light-blue">
      <!--Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"  Tip 2: you can also add an image using data-image tag-->
      <div class="sidebar-wrapper">
        <div class="logo">
          <a href="monitoramento" class="simple-text">
            Hidro Monitor
          </a>
        </div>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/menu/monitoramento">
              <i class="nc-icon nc-tv-2"></i>
              <p>Monitoramento</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/menu/dados">
              <i class="nc-icon nc-chart-bar-32"></i>
              <p>Dados</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/menu/controles">
              <i class="nc-icon nc-settings-gear-64"></i>
              <p>Controles</p>
            </a>
          </li>

          <hr style="border: 0; border-top: 1px solid #fff;">
          <li class="nav-item">
            <a class="nav-link" href="../desconectar">
              <i class="nc-icon nc-button-power"></i>
              <p>Desconectar</p>

            </a>
          </li>
          <hr style="border: 0; border-top: 1px solid #fff;">


          <li class="nav-item active active-pro">
            <a class="nav-link active"
              href="mailto:eng.victoreustaquio@gmail.com?subject=Suporte HidroMonitor&body=Bem-vindo ao suporte! %0AInforme os seguintes dados...%0A%0ANome Completo:%0ANúmero para contato:%0A%0A%0ADescreva seu problema aqui:%0ASugestões:%0AElogios:%0A%0A%0A%0A">
              <i class="nc-icon nc-email-83"></i>
              <p>E-MAIL DE SUPORTE</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <!-- MAIN PANEL -->
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg " color-on-scroll="500">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="/menu/monitoramento"> Dashboard: Monitoramento</a>
          </div>
          <button href="navbar-toggler" class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-bar burger-lines"></span>
            <span class="navbar-toggler-bar burger-lines"></span>
            <span class="navbar-toggler-bar burger-lines"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                <center><i class="nc-icon nc-circle-09"></i></center>

                <a class="" style="text-align: center;">

                  <h5 style="text-transform: uppercase;">{{ nome }}</h5>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid card-center-vk">
          <div class="row">
            <div class="col-sm-12">
              <div class="card card-tasks">
                <div class="card-header ">
                  <h4 class="card-title">Controles</h4>
                  <p class="card-category">Válvula Senoidal e Sensor de Presença</p>
                  <hr>
                </div>

                <div class="card-body">
                  <div id="painel-controle">
                    <hr>
                    <div class="row" style="background-color:#3c98d5fa;">
                      <div class="col-sm-12 select-align-center">
                        <h4 style="color: white; margin-top: 0px; margin-bottom: 6px;">Dispositivo</h4>
                        <select id="select-dispositivo" name="dispositivo" class="classic"
                          onchange="renderStatusDispositivos(localDispositivosData)">
                          {{#each dispositivos as | dispositivo |}}
                          <option value="{{dispositivo.macId}}">{{dispositivo.nome}}</option>
                          {{/each}}
                        </select>
                      </div>
                    </div>

                    <!-- ROW 1-->
                    <div class="row" style="background-color:#b1dcf9;">
                      <div class="col-sm-6">
                        <!-- Slider button para Sensor Presença-->
                        <center>
                          <div class="slidecontainer">
                            <h4> Sensor Presença<br><span id="span-title-sensor-presenca"> {{#if
                                status_sensor_presenca}}LIGADO{{else}}DESLIGADO{{/if}}</span></h4>
                            <label class="switch">
                              <input id="checkbok-sensor-presenca" type="checkbox"
                                onchange="mudarEstadoSensorPresenca(this)">
                              <span class="slider1 round"></span>
                            </label>
                          </div>
                        </center>
                      </div>

                      <div class="col-sm-6">
                        <!-- Slider button  para controle Rele-->
                        <center>
                          <div class="slidecontainer">
                            <h4> Valvula Solenoide<br><span id="span-title-valvula-solenoide"> {{#if
                                status_valvula_solenoide}}LIGADO{{else}}DESLIGADO{{/if}}</span></h4>
                            <label class="switch">
                              <input id="checkbox-valvula-solenoide" type="checkbox"
                                onchange="mudarEstadoValvulaSolenoide(this)">
                              <span class="slider1 round"></span>
                            </label>
                          </div>
                        </center>
                      </div>
                    </div>
                    <!-- ROW 2-->
                    <br>
                    <div class="row">
                      <div class="col-sm-6">
                        <center>
                          <span id="span-sensor-presenca">
                          </span>
                        </center>
                      </div>
                      <div class="col-sm-6">
                        <center>
                          <span id="span-valvula-solenoide">
                          </span>
                        </center>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-sm-4">
                        <div id="g1"></div>
                        <h4 id="fluxo_id"> {{content.fluxoMsg}} </h4>
                      </div>
                      <div class="col-sm-4">
                        <div id="g2"></div>
                        <h4 id="sm_id"> {{content.moistureMsg}} </h4>
                      </div>
                    </div>
                  </div>
                  <br>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{> footer}}
    </div>
  </div>



  <!--   Core JS Files   -->
  <script src="/javascript/core/jquery.3.2.1.min.js" type="text/javascript"></script>
  <script src="/javascript/core/popper.min.js" type="text/javascript"></script>
  <script src="/javascript/core/bootstrap.min.js" type="text/javascript"></script>
  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <script src="/plugins/bootstrap-switch.js"></script>
  <!--  Chartist Plugin  -->
  <script src="/plugins/chartist.js"></script>
  <!--  Notifications Plugin    -->
  <!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
  <script src="/javascript/light-bootstrap-dashboard.js" type="text/javascript"></script>
  <!-- Light Bootstrap Dashboard DEMO methods, don't include it in your project! -->



  <!--CHARTJS JS-->
  <script src="/plugins/charts/chartjs/2.9.3/Chart.min.js"></script>
  <script src="/plugins/charts/chartjs/utils.js"></script>


  <!--CHARTJS REALTIME-->
  <script src='/plugins/charts/chart_raphael/raphael.2.1.0.min.js'></script>
  <script src='/plugins/charts/chart_justgage/justgage.1.0.1.min.js'></script>


  <!--APEX REALTIME-->
  <script src='/plugins/charts/chart_apex/apexcharts.js'></script>
  <script src="/plugins/socket.io/2.3.0/socket.io.js"></script>

  <script>
    var localDispositivosData = {{{ json dispositivos }}}
    console.log('dispositivos ----> ', JSON.stringify(localDispositivosData, null, 2));
    const firstDeviceId = localDispositivosData ? localDispositivosData[0].id : null
  </script>

  <script>
    //CONEXÃO SOCKET
    var socket = io.connect();

    var EspDATAgauge = { fluxo: "Carregando" };
    var EspDATA = { fluxo: "0" };


    //socket.emit('server message', "Me conectei : ");
    //FROM SERVER
    socket.on('server message', function (msg) {
      //console.log("RECEBI: ", msg.fluxo)

      EspDATA = msg;
      EspDATAgauge = msg;

    });

  </script>


  <script>

    var mudarEstadoSensorPresenca = (element) => {
      if (typeof element?.checked !== "boolean") {
        return
      }
      const selectedMacId = $('#select-dispositivo').val()
      const dispositivoData = localDispositivosData?.find(dispositivo => dispositivo.macId === selectedMacId)

      if (dispositivoData?.id) {
        $.ajax({
          url: "/api/sensor-presenca",
          method: "put",
          data: { deviceId: dispositivoData?.id, status: element.checked },
          success: function (data) {
            const { dispositivos } = data || {};
            localDispositivosData = dispositivos
            renderStatusDispositivos(dispositivos)
          }
        });
      }
    }


    var mudarEstadoValvulaSolenoide = (element) => {
      if (typeof element?.checked !== "boolean") {
        return
      }
      const selectedMacId = $('#select-dispositivo').val()
      const dispositivoData = localDispositivosData?.find(dispositivo => dispositivo.macId === selectedMacId)

      if (dispositivoData?.id) {
        $.ajax({
          url: "/api/valvula-solenoide",
          method: "put",
          data: { deviceId: dispositivoData.id, status: element.checked },
          success: function (data) {
            console.log('data ----> ', data);
            const { dispositivos } = data || {};
            localDispositivosData = dispositivos
            renderStatusDispositivos(dispositivos)
          }
        });
      }
    }

  </script>


  <script>

    function checkboxValvulaSolenoideEnabled() {
      $('#checkbox-valvula-solenoide').attr("disabled", false);
    }

    function checkboxValvulaSolenoideDisabled() {
      $('#checkbox-valvula-solenoide').attr("disabled", true);
    }

    function renderValvulaSolenoideEnabled() {
      $('#span-valvula-solenoide').html(`<img class="logo" src="/assets/images/solenoide-ligado.svg" alt="attention" width="20%" style="margin-left: -12%;">`)
      $('#checkbox-valvula-solenoide').prop("checked", true);
      $("#span-title-valvula-solenoide").html("LIGADO");
    }

    function renderValvulaSolenoideDisabled() {
      $('#span-valvula-solenoide').html(`<img class="logo" src="/assets/images/solenoide-desligado.svg" alt="attention" width="20%" style="margin-left: -12%;">`)
      $('#checkbox-valvula-solenoide').prop("checked", false);
      $("#span-title-valvula-solenoide").html("DESLIGADO");
    }

    function renderSensorPresencaEnabled() {
      $('#span-sensor-presenca').html(`<img class="logo" src="/assets/images/sensor-presenca-ligado.svg" alt="attention" width="12%">`);
      $('#checkbok-sensor-presenca').prop("checked", true);
      $("#span-title-sensor-presenca").html("LIGADO");
    }

    function renderSensorPresencaDisabled() {
      $('#span-sensor-presenca').html(`<img class="logo" src="/assets/images/sensor-presenca-desligado.svg" alt="attention" width="12%">`);
      $('#checkbok-sensor-presenca').prop("checked", false);
      $("#span-title-sensor-presenca").html("DESLIGADO");
    }


    const renderStatusDispositivos = (newDispositivosData) => {
      const thisDispositivosData = newDispositivosData || localDispositivosData
      if (!thisDispositivosData) {
        return
      }

      const dispositivoSelecionado = $('#select-dispositivo').val()
      const dispositivoData = thisDispositivosData?.find(dispositivo => dispositivo.macId === dispositivoSelecionado)

      const { estado: estadoSensorPresenca } = dispositivoData?.SensorPresenca || {}
      const { estado: estadoValvulaSolenoide } = dispositivoData?.ValvulaSolenoide || {}

      if (estadoSensorPresenca) {
        renderSensorPresencaEnabled()
        renderValvulaSolenoideDisabled()
        checkboxValvulaSolenoideDisabled()
      } else {
        renderSensorPresencaDisabled()
        checkboxValvulaSolenoideEnabled()
      }

      if (estadoValvulaSolenoide) {
        renderValvulaSolenoideEnabled()
      } else {
        renderValvulaSolenoideDisabled()
      }

    }



  </script>


  <script>
    renderStatusDispositivos(localDispositivosData, firstDeviceId)
  </script>
</body>

</html>
