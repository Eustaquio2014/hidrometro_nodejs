<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="Content-Language" content="pt-br">
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/assets/img/favicon.ico">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Hidro Monitor</title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="/assets/css/light-bootstrap-dashboard.css?v=2.0.0 " rel="stylesheet" />
  <link rel="stylesheet" type="text/css"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/css/datepicker.css" />


  <!--CHARTJS CSS-->
  <link rel="stylesheet" type="text/css" href="/plugins/charts/chartjs/css/style_chartjs.css">
  <link rel="stylesheet" type="text/css" href="/assets/css/select.css">
  <style>
    canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
  </style>
  <style>
    .container {
      max-width: 600px;
    }

    .box {
      padding: 50px;
      background: #ffffff;
      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
    }

    .box h3 {
      text-align: center;
      padding: 0 0 30px 0;
    }

    .box .form-control {
      max-width: 300px;
      margin: 0 auto;
    }

    .datepicker {
      font-family: 'Exo 2', sans-serif;
    }

    .datepicker--cell.-range-to- {
      background: rgba(206, 229, 248, 0.4);
      border-color: rgb(42, 147, 245);
    }

    .datepicker--cell.-current- {}

    .datepicker--cell.-selected-,
    .datepicker--cell.-selected-.-focus- {
      background-color: #3f8fdae1;
      color: #000000;
    }

    .datepicker--cell.-in-range- {
      background: rgba(206, 231, 248, 0.2);
    }

    .datepicker--cell-day {
      font-weight: 500;
      color: #000000;
    }

    .form-control {
      height: 50px;
      font-size: 16px;
      color: #414D64;
      background: #ffffff;
      padding: 0 15px;
      border: 2px solid #DADEEA;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      -webkit-transition: all 0.3s ease-in-out;
      -moz-transition: all 0.3s ease-in-out;
      -o-transition: all 0.3s ease-in-out;
      transition: all 0.3s ease-in-out;
      text-align: center;
    }

    textarea.form-control {
      height: 120px;
      padding-top: 15px;
    }

    .form-control-plaintext {
      font-size: 18px;
      color: #434343;
    }

    button.form-control {
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .form-control:focus {
      border-color: #37B448;
      -webkit-box-shadow: 0px 2px 6px rgba(55, 180, 72, .15);
      -moz-box-shadow: 0px 2px 6px rgba(55, 180, 72, .15);
      box-shadow: 0px 2px 6px rgba(55, 180, 72, .15);
    }
  </style>
</head>

<body class="">
  <div class="wrapper">
    <div class="sidebar" data-image="/assets/img/4.png" data-color="light-blue">
      <!--Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"  Tip 2: you can also add an image using data-image tag-->
      <div class="sidebar-wrapper">
        <div class="logo">
          <a href="monitoramento" class="simple-text">
            Hidro Monitor
          </a>
        </div>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="/menu/monitoramento">
              <i class="nc-icon nc-tv-2"></i>
              <p>Monitoramento</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/menu/dados">
              <i class="nc-icon nc-chart-bar-32"></i>
              <p>Dados</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/menu/controles">
              <i class="nc-icon nc-settings-gear-64"></i>
              <p>Controles</p>
            </a>
          </li>

          <hr style="border: 0; border-top: 1px solid #fff;">
          <li class="nav-item">
            <a class="nav-link" href="../desconectar">
              <i class="nc-icon nc-button-power"></i>
              <p>Desconectar</p>

            </a>
          </li>
          <hr style="border: 0; border-top: 1px solid #fff;">


          <li class="nav-item active active-pro">
            <a class="nav-link active"
              href="mailto:eng.victoreustaquio@gmail.com?subject=Support HidroMonitor&body=Bem-vindo ao suporte! %0AInforme os seguintes dados...%0A%0ANome Completo:%0ANúmero para contato:%0A%0A%0ADescreva seu problema aqui:%0ASugestões:%0AElogios:%0A%0A%0A%0A">
              <i class="nc-icon nc-email-83"></i>
              <p>E-MAIL DE SUPORTE</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <!-- MAIN PANEL -->
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg " color-on-scroll="500">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="/menu/monitoramento"> Dashboard: Monitoramento</a>
          </div>
          <button href="navbar-toggler" class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-bar burger-lines"></span>
            <span class="navbar-toggler-bar burger-lines"></span>
            <span class="navbar-toggler-bar burger-lines"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                <center><i class="nc-icon nc-circle-09"></i></center>

                <a class="" style="text-align: center;">

                  <h5 style="text-transform: uppercase;">{{ nomeusuario }}</h5>
                </a>
              </li>

            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid card-center-vk">
          <div class="row">
            <div class="col-sm-12">
              <div class="card card-tasks">
                <div class="card-header">
                  <h4 class="card-title">Consumo Histórico</h4>
                  <p class="card-category" id="chartpreview" style="font-size: 16px;">
                  <p class="card-category" id="chartpreview2" style="font-size: 16px;"> Carregando Dados...</p>
                  </p>

                </div>
                <div class="card-body">
                  <hr>
                  <div class="row" style="background-color:#3c98d5fa;">
                    <div class="col-sm-12 select-align-center">
                      <h4 style="color: white; margin-top: 0px; margin-bottom: 6px;">Dispositivo</h4>
                      <select id="select-device" name="dispositivo" class="classic" onchange="loadConsumoDiario()">
                        {{#each dispositivos as | dispositivo |}}
                        <option value="{{dispositivo.macId}}">{{dispositivo.nome}}</option>
                        {{/each}}
                      </select>
                    </div>
                                        <div class="col-sm-12 select-align-center">
                      <h4 style="color: white; margin-top: 0px; margin-bottom: 6px;">Agrupar</h4>
                      <select id="select-group" name="agrupamento" class="classic" onchange="loadConsumoDiario()">
                        <option value="byMonth">Por Mês</option>
                        <option value="byDay" selected="true">Por Dia</option>
                        <option value="byHour">Por Hora</option>

                      </select>
                    </div>
                  </div>
                  <div class="row" style="background-color:#3c98d5fa;">
                    <div class="col-sm-12 select-align-center">
                      <center>
                        <h4 style="color: white; margin-top: 0px; margin-top: 6px; margin-bottom: 6px;">Período</h4>
                      </center>
                      <input type="text" class="datepicker-here form-control classic" id="date-range"
                        data-date-format="dd/mm/yyyy" data-language='pt-BR' placeholder="Selecionar data ou período">
                      <br>
                    </div>
                  </div>
                  <hr>
                  <div class="card-body">
                    <canvas id="canvas"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{> footer}}
    </div>
  </div>


  <script src="/javascript/core/jquery.3.2.1.min.js" type="text/javascript"></script>

  <!--   Core JS Files   -->
  <script src="/javascript/core/popper.min.js" type="text/javascript"></script>
  <script src="/javascript/core/bootstrap.min.js" type="text/javascript"></script>

  <!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
  <script src="/plugins/bootstrap-switch.js"></script>
  <!--  Chartist Plugin  -->
  <script src="/plugins/chartist.js"></script>
  <!--  Notifications Plugin    -->
  <script src="/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
  <script src="/javascript/light-bootstrap-dashboard.js?v=2.0.0" type="text/javascript"></script>
  <!-- Light Bootstrap Dashboard DEMO methods, don't include it in your project! -->

  <!--CHARTJS JS-->
  <script src="/plugins/charts/chartjs/2.9.3/Chart.min.js"></script>
  <script src="/plugins/charts/chartjs/utils.js"></script>

  <script src="/plugins/air-datepicker/popper.js"></script>
  <script src="/plugins/air-datepicker/bootstrap.js"></script>
  <script src="/plugins/air-datepicker/datepicker.js"></script>
  <script src="/plugins/air-datepicker/locale/datepicker.pt-BR.min.js"></script>


  <script>
    var localDispositivosData = {{{ json dispositivos }}}
    console.log('dispositivos ----> ', JSON.stringify(localDispositivosData, null, 2));
    const firstDeviceId = localDispositivosData ? localDispositivosData[0].id : null
  </script>

  <script>

    function debounce(func, timeout = 1000) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
      };
    }
    function saveInput(data) {
      console.log('Saving data', data.toString());
    }
    const processChange = debounce((data) => saveInput(data));
  </script>

  <script>
    var mindate = new Date();
    mindate.setDate(mindate.getDate() - 1825);
    var maxdate = new Date();
    maxdate.setDate(maxdate.getDate() - 1);

    $('#date-range').datepicker({
      language: 'pt-BR',
      range: true,
      minDate: mindate,
      maxDate: maxdate,
      multipleDates: true,
      multipleDatesSeparator: " - ",
      position: 'bottom center',
      onHide: function (datepicker, animationCompleted) {
        if (animationCompleted) {
          /*{{!--   const dates = datepicker.selectedDates
            const datesFormatted = []

            for (const date of dates) {
              datesFormatted.push(date.toLocaleDateString())
            }

            const payload = {
              startDate: datesFormatted.shift(),
              endDate: datesFormatted.pop(),

            } --}}*/
          loadConsumoDiario()
        }
      },
      onSelect: function (dateText) {
      },
    })
  </script>

  <script type="text/javascript">
    const selectedGroup = $('#select-group').val()
    function initCanvas(data) {
      const { dias = [], consumo_diario = [] } = data || {}
      var config = {
        type: 'line',
        data: {
          labels: dias,
          datasets: [
            {
              label: selectedGroup,
              pointBackgroundColor: window.chartColors.lightblue,
              pointBorderColor: window.chartColors.blue,
              backgroundColor: window.chartColors.lightblue,
              borderColor: "rgb(0, 100, 200)",
              borderWidth: "2",
              data: consumo_diario,
              fill: true,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          title: {
            display: false,
            text: 'Gráfico Consumo Diário'
          },
          tooltips: {
            mode: 'nearest', //mode: 'index',  para exibir os valores de um mesmo dia no mesmo hover tip
            intersect: true,
          },
          hover: {
            mode: 'nearest',
            intersect: true
          },
          scales: {
            xAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Dias'
              }
            }],
            yAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Litros'
              }
            }]
          }
        }
      };
      const chartElement = document.getElementById('canvas');
      chartElement.height = 400;
      window.myChart = new Chart(chartElement, config);
    }

    function dataSetUpdate(chart, selectGroup) {
        const labels = {
            byMonth:'Litros por mês',
            byDay:'Litros por dia',
            byHour:'Litros por hora'
        }
        chart.data.datasets.forEach(dataset => dataset.label = labels[selectGroup] ||'')
    }


    function addData(chart, labels, newData) {

      chart.data.labels = labels
      chart.data.datasets.forEach((dataset) => {
        dataset.data = newData;
      });
      dataSetUpdate(chart, $('#select-group').val())
      chart.update();
    }

    function removeData(chart) {
      if (chart.data) {
        chart.data.labels.pop();
        chart.data.datasets.forEach((dataset) => {
          dataset.data.pop();
        });
        dataSetUpdate(chart, $('#select-group').val())
        chart.update();
      }

    }


    function chartConsumoHistorico(chart, content) {

      //removeData(chart)

      var { dataUltimoConsumo = '' } = content || {};
      if (dataUltimoConsumo) {
        document.getElementById("chartpreview").innerHTML = "Último consumo registrado";
      }
      document.getElementById("chartpreview2").innerHTML = dataUltimoConsumo;

      var consumo_diario = content?.dados?.map(item => Number((item.soma_fluxo_litros_segundo / 60) / 2).toFixed(2));
      var dias = content?.dados?.map(item => item.data);

      const dataInicio = dias?.length ? dias[0] : ''
      const dataFim = dias?.length ? dias[dias?.length - 1] : ''

      if (dataInicio && dataFim) {
        $('#date-range').attr('placeholder', `${dataInicio.replace(/-/g, "/")} - ${dataFim.replace(/-/g, "/")}`)
      }

      addData(chart, dias, consumo_diario)

    }

    function loadConsumoDiario() {

      const selectedMacId = $('#select-device').val()
      const selectedGroup = $('#select-group').val()

      const dispositivoData = localDispositivosData?.find(dispositivo => dispositivo.macId === selectedMacId)

      const data = $('#date-range').val()
      const payload = {
        startDate: data?.slice(0, 10) || null,
        endDate: data?.slice(13, 24) || null,
        groupBy: selectedGroup
      }

      $.ajax({
        url: "/dados/consumo",
        type: "post",
        data: {
          deviceId: dispositivoData.macId || firstDeviceId,
          ...payload
        }
      }).done(function (response) {
        const { dataUltimoConsumo } = response

        if (dataUltimoConsumo) {
          var parts = dataUltimoConsumo?.split(/[\s\/:-]/);
          var maxdate = new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5]);
          if (dataUltimoConsumo && maxdate) {
            $('#date-range').datepicker({
              maxDate: maxdate,
            })
          }
        }
        chartConsumoHistorico(window.myChart, response)
      });
    }


    $(document).ready(function () {
      initCanvas();
      loadConsumoDiario();
    });
  </script>
</body>

</html>
